#!/bin/bash

[ -z "$CRYVAR_BSDIR" ] && CRYVAR_BSDIR="$HOME/crydarba/tmpl/basis"
[ -z "$CRYVAR_FXLDIR" ] && CRYVAR_FXLDIR="$HOME/crydarba/tmpl/fxnls"
[ -z "$CRYVAR_TMPLDIR" ] && CRYVAR_TMPLDIR="$HOME/crydarba/tmpl"

fxnls=""; bases=""; pcryln=""; cmpd=""; tmpln=""
read -p "Please input the compound name:  " cmpd
read -p "Please input the template name:  " tmpln
read -p "Please input all the functionals You want to use, separating names with a space:  " fxnls
read -p "Please input all the basis sets You want to use, separating names with a space:  " bases
read -p "Please paste here the line from prep2cry.sh output You got after processing the .CIF file:  " pcryln
lelm="$(echo "$pcryln" | grep -o -e '-w ".*"' | sed 's@-w "@@;s@#"$@@;s@#@\n@g' | gawk '{print $1}')"
#echo "$lelm"

selbas=""; aselbas=""
for un in $fxnls; do
    for eun in $bases; do
        curselbas=""
        for lun in $lelm; do
            el=$(sed -n "${lun}p" $HOME/.pertanu)
            basfile="$CRYVAR_BSDIR/${el}/${eun}.bas"
            if [ ! -f "$basfile" ] && [ ! -L "$basfile" ]; then
                printf "%$(tput cols)s" | tr ' ' '='; echo ""
                echo -e "ATTENTION: Cannot find the basis set file \e[41;97m ${eun} \e[m for element \e[41;97m ${el} \e[m!"
                echo -e "Found these basis sets for this element:\n   \e[44;97m$(ls -l "$CRYVAR_BSDIR/${el}" | grep -v -e '^total' -e '^l' | gawk '{print $NF}' | xargs | sed 's@\s\+@\\e[m&\\e[44;97m@g')\e[m"
                read -p "Which of them should we use for this element? Copy from above and paste the name here:  " selbas
                [ -z "$selbas" ] && echo "Aborting." && exit 2
                selbas="${selbas%.bas}.bas"
                aselbas="$aselbas ${el}:${selbas}"
                ln -s "$CRYVAR_BSDIR/${el}/${selbas}" "$CRYVAR_BSDIR/${el}/${eun}.bas"
            fi
            [ -L "$CRYVAR_BSDIR/${el}/${eun}.bas" ] && curselbas="$curselbas ${el}:$(basename $(ls -l "$CRYVAR_BSDIR/${el}/${eun}.bas" | gawk '{print $NF}'))"
        done
        if [ -f "${CRYVAR_FXLDIR}/${un}.fxl" ] || [ -L "${CRYVAR_FXLDIR}/${un}.fxl" ]; then
            unn="$(fxnl2cry.sh ${un})"
        else
            unn="$un"
        fi
        curn="${un}_${eun/_/}"
        mkdir "$curn"
        cd "$curn"
        echo -e "\n" | eval "$pcryln" -d "$unn" -b "$eun" -t "$tmpln" -c "\"${cmpd} ${tmpln#tmpl_} $un $eun $curselbas\"" "${cmpd}_${curn}_${tmpln#tmpl_}.d12"
        cd ..
    done
done

for un in $aselbas; do
    el="$(echo "$un" | cut -d : -f 1)"
    realbas="$(echo "$un" | cut -d : -f 2)"
    fakebas="$(ls -l "$CRYVAR_BSDIR/${el}" | grep '^l' | grep "$realbas" | cut -d '>' -f 1 | sed 's@ -$@@' | gawk '{print $NF}' | xargs)"
    for dfdfdf in $fakebas; do
        [ -f "$CRYVAR_BSDIR/${el}/${dfdfdf}" ] && rm "$CRYVAR_BSDIR/${el}/${dfdfdf}" || echo "DEBUG: CAL: for some reason ${dfdfdf} file was not present!"
    done
done

